<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ekart - Payment Options</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { background-color: #f8fafc; display: flex; justify-content: center; align-items: center; min-height: 100vh; font-family: 'Poppins', sans-serif; margin: 0; }
        .payment-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; max-width: 450px; width: 100%; }
        .amount-box { background-color: #f1f5f9; padding: 15px; border-radius: 10px; margin: 20px 0; }
        .amount-value { font-size: 28px; font-weight: bold; color: #2563eb; }
        .btn-pay { font-weight: 600; padding: 12px 20px; border-radius: 8px; width: 100%; border: none; font-size: 16px; transition: 0.3s; margin-bottom: 10px; }
        .btn-online { background-color: #2563eb; color: white; }
        .btn-cod { background-color: #10b981; color: white; }
        .cancel-link { display: block; margin-top: 15px; color: #64748b; text-decoration: none; }
    </style>
</head>
<body>

    <div class="payment-card">
        <div class="mb-3">
            <i class="fas fa-credit-card fa-4x text-primary"></i>
        </div>
        <h3>Select Payment Method</h3>

        <div class="mb-4 text-left border-bottom pb-2">
    <h6 class="text-muted small font-weight-bold text-uppercase">
        <i class="fas fa-truck mr-1"></i> Shipping To:
    </h6>
    <p class="mb-1 text-dark font-weight-bold" 
   th:if="${customer.addresses != null and !customer.addresses.isEmpty()}" 
   th:text="${customer.addresses.get(customer.addresses.size() - 1).details}">
</p>

<p class="mb-1 text-danger small" 
   th:if="${customer.addresses == null or customer.addresses.isEmpty()}">
   ⚠️ No shipping address found. Please add one.
</p>
    <a href="/customer/address" class="small text-primary">Change Address</a>
</div>
        
        <div class="amount-box">
            <div class="text-muted small">Total Payable Amount</div>
            <div class="amount-value">₹ <span id="displayAmount" th:text="${amount}">0.0</span></div>
        </div>

        <button id="rzp-button1" class="btn-pay btn-online">
            <i class="fas fa-globe mr-2"></i> Pay Online
        </button>

        <form action="/success" method="post">
            <input type="hidden" name="amount" th:value="${amount}">
            <input type="hidden" name="paymentMode" value="Cash on Delivery">
            <input type="hidden" name="razorpay_payment_id" value="COD_NA">
            <input type="hidden" name="razorpay_order_id" value="COD_ORDER">
            
            <button type="submit" class="btn-pay btn-cod">
                <i class="fas fa-hand-holding-usd mr-2"></i> Cash on Delivery
            </button>
            <div class="form-group mt-3 text-left">
    <label><strong>Select Delivery Slot:</strong></label>
    <select name="deliveryTime" class="form-control" required>
        <option value="" disabled selected>Choose a time slot...</option>
        <option value="Morning (9 AM - 12 PM)">Morning (9 AM - 12 PM)</option>
        <option value="Afternoon (1 PM - 4 PM)">Afternoon (1 PM - 4 PM)</option>
        <option value="Evening (5 PM - 8 PM)">Evening (5 PM - 8 PM)</option>
    </select>
</div>
        </form>
        
        <div class="text-center mt-4">
    <a href="/customer/view-products" class="btn btn-outline-primary shadow-sm" 
       style="border-radius: 10px; padding: 10px 25px; font-weight: 600; border-width: 2px;">
        <i class="fas fa-shopping-bag mr-2"></i> CONTINUE SHOPPING
    </a>
</div>
<div th:if="${recommendedProducts != null and !#lists.isEmpty(recommendedProducts)}" 
     class="mt-5 pt-4" style="border-top: 2px dashed #eee;">
    
    <h5 class="font-weight-bold mb-4 text-center">
        <i class="fas fa-lightbulb text-warning mr-2"></i> 
        Wait! Would you like to add these <span class="text-primary" th:text="${cartItemCategory}"></span> items?
    </h5>
    
    <div class="row justify-content-center">
        <div class="col-6 mb-3" th:each="rp : ${recommendedProducts}">
            <div class="card shadow-sm border-0 h-100" style="border-radius: 12px; background: #fff;">
                <img th:src="${rp.imageLink}" class="card-img-top p-2" 
                     style="height: 100px; object-fit: cover; border-radius: 15px;">
                <div class="card-body p-2 text-center">
                    <h6 class="font-weight-bold mb-1" style="font-size: 0.8rem;" th:text="${rp.name}"></h6>
                    <p class="text-primary font-weight-bold mb-2" style="font-size: 0.85rem;" th:text="'₹' + ${rp.price}"></p>
                    <a th:href="'/add-cart/' + ${rp.id}" class="btn btn-sm btn-primary btn-block" 
                       style="border-radius: 6px; font-size: 0.7rem;">Add to Cart</a>
                </div>
            </div>
        </div>
    </div>
</div>
        <a href="/view-cart" class="cancel-link">Cancel and Go Back</a>

    </div>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script th:inline="javascript">
        var totalAmount = /*[[${amount}]]*/ 0;
        var customerName = /*[[${customer.name}]]*/ 'Customer';
        var customerEmail = /*[[${customer.email}]]*/ 'email@example.com';

        document.getElementById('rzp-button1').onclick = function(e){
            var options = {
                "key": "YOUR_RAZORPAY_KEY_ID", // Replace with your actual Key ID
                "amount": totalAmount * 100, // Razorpay works in paise (100 paise = 1 Rupee)
                "currency": "INR",
                "name": "Ekart Shop",
                "description": "Order Payment",
                "handler": function (response){
                    // This function runs AFTER successful online payment
                    var form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/success';

                    var fields = {
                        'amount': totalAmount,
                        'paymentMode': 'Online',
                        'razorpay_payment_id': response.razorpay_payment_id,
                        'razorpay_order_id': response.razorpay_order_id
                    };

                    for (var key in fields) {
                        var input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = fields[key];
                        form.appendChild(input);
                    }

                    document.body.appendChild(form);
                    form.submit();
                },
                "prefill": {
                    "name": customerName,
                    "email": customerEmail
                },
                "theme": { "color": "#2563eb" }
            };
            var rzp1 = new Razorpay(options);
            rzp1.open();
            e.preventDefault();
        }
    </script>
</body>
</html>